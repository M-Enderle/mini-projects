{% extends "layout.html" %}

{% block title %}{% if is_new %}Neues Rezept{% else %}Rezept bearbeiten{% endif %} · Rezeptbuch{% endblock %}

{% block content %}
<section class="form-shell">
  <header>
    <h1>{% if is_new %}Neues Rezept{% else %}Rezept bearbeiten{% endif %}</h1>
  </header>

  <form method="post" class="recipe-form" enctype="multipart/form-data">
    <textarea name="recipe_payload" hidden>{% if recipe_payload is not none %}{{ recipe_payload|tojson }}{% endif %}</textarea>

    {% if not is_new %}
    <section class="prompt-panel">
      <header>
        <h2>Prompt-Studio</h2>
      </header>
      <textarea name="prompt_text" rows="4" placeholder="z.B. Mach das Rezept vegan, erhöhe den Proteingehalt und formuliere die Schritte kompakter." class="prompt-input">{{ prompt_text }}</textarea>
      <div class="prompt-actions">
        <button type="submit" name="action" value="prompt_generate" class="button">Prompt anwenden</button>
        <button type="submit" name="action" value="reset" class="button muted" {% if not can_save %}disabled{% endif %}>Zurücksetzen</button>
      </div>
    </section>
    {% endif %}

    {% if is_new %}
    <section class="ai-panel ai-starters">
      <div class="ai-grid">
        <div class="ai-card">
          <h3>Bild-basiert</h3>
          <input type="file" name="gemini_image" accept="image/*" class="ai-input">
          <button type="submit" name="action" value="generate_image" class="button ai-button" formnovalidate>Aus Bild starten</button>
        </div>
        <div class="ai-card">
          <h3>Text-basiert</h3>
          <textarea name="gemini_text" rows="3" placeholder="Zum Beispiel: Cremiges Zitronenrisotto mit karamellisierten Pilzen" class="ai-input"></textarea>
          <button type="submit" name="action" value="generate_text" class="button ai-button" formnovalidate>Aus Text starten</button>
        </div>
        <div class="ai-card">
          <h3>URL-basiert</h3>
          <input type="url" name="gemini_url" placeholder="https://beispiel.de/rezept" class="ai-input">
          <button type="submit" name="action" value="generate_url" class="button ai-button" formnovalidate>Aus URL starten</button>
        </div>
      </div>
    </section>
    {% endif %}

    {% if preview_warnings %}
    <section class="preview-warnings" role="alert">
      <h2>Bitte prüfen</h2>
      <ul>
        {% for message in preview_warnings %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </section>
    {% endif %}

    <section class="recipe-preview">
      <header>
        <div>
          <h2>Rezept-Vorschau</h2>
        </div>
      </header>

      {% if recipe_payload %}
      <article class="preview-body">
        <div class="preview-headline">
          <h3>{{ recipe_payload.title or "Noch kein Titel" }}</h3>
          <p>{{ recipe_payload.description or "Die Beschreibung folgt nach dem nächsten Prompt." }}</p>
        </div>
        <div class="preview-meta">
          <span class="meta-item">
            <span class="meta-label">Quelle</span>
            <span class="meta-value">{{ recipe_payload.source or "Unbekannt" }}</span>
          </span>
          <span class="meta-item">
            <span class="meta-label">Personen</span>
            <span class="meta-value">{{ recipe_payload.portions or 4 }}</span>
          </span>
          {% if recipe_payload.total_time %}
          <span class="meta-item">
            <span class="meta-label">Zeit</span>
            <span class="meta-value time-badge">{{ recipe_payload.total_time }} min</span>
          </span>
          {% endif %}
        </div>
        <div class="preview-tags">
          {% if recipe_payload.filters %}
            {% for tag in recipe_payload.filters.split(',') %}
              {% set clean = tag.strip() %}
              {% if clean %}<span>{{ clean }}</span>{% endif %}
            {% endfor %}
          {% else %}
            <span class="placeholder">Noch keine Filter vergeben</span>
          {% endif %}
        </div>

        <div class="preview-columns">
          <div class="preview-section">
            <h3>Zutaten</h3>
            {% set ingredients = recipe_payload.ingredients or [] %}
            {% if ingredients %}
            <ul>
              {% for item in ingredients %}
                {% if item.startswith('#') %}
                  <li class="preview-divider">{{ item.lstrip('#').strip() }}</li>
                {% else %}
                  <li>{{ item }}</li>
                {% endif %}
              {% endfor %}
            </ul>
            {% else %}
            <p class="preview-placeholder">Führe im Prompt Zutaten oder Mengen auf – die KI übernimmt den Rest.</p>
            {% endif %}
          </div>
          <div class="preview-section">
            <h3>Schritte</h3>
            {% set steps = recipe_payload.steps or [] %}
            {% if steps %}
            <ol>
              {% for step in steps %}
              <li>{{ step }}</li>
              {% endfor %}
            </ol>
            {% else %}
            <p class="preview-placeholder">Beschreibe im Prompt, welche Abläufe du brauchst – die Schritte aktualisieren sich automatisch.</p>
            {% endif %}
          </div>
        </div>
      </article>
      {% else %}
      {% endif %}
    </section>

    <fieldset class="image-options">
      <legend>Rezeptbild (manuell)</legend>
      {% if display_image_url %}
      <div class="current-image">
        <label>Aktuelles Bild</label>
        <img src="{{ display_image_url }}" alt="Aktuelles Rezeptbild">
      </div>
      <div class="divider-text">Neues Bild wählen</div>
      {% endif %}
      <label>
        <span>Bild hochladen</span>
        <input type="file" name="image_upload" accept="image/*" class="file-input">
        <small class="help-text">JPG, PNG, WebP oder GIF bis 5MB</small>
      </label>
      <div class="divider-text">oder</div>
      <label>
        <span>Bild-URL</span>
        <!-- Only pre-fill the input for external URLs. Local uploaded images are shown above
             as a preview but not exposed as a filesystem/static path in the input field. -->
        <input type="url" name="image_url" value="{{ manual_image_url_input or '' }}" placeholder="https://...">
        <small class="help-text">Direkter Bildlink – alternativ eigenes Bild hochladen</small>
      </label>
    </fieldset>

    <fieldset class="recipe-metadata">
      <legend>Rezeptinformation</legend>
      <label>
        <span>Anzahl Personen (Portionsgröße)</span>
        <input type="number" id="portions-input" name="portions" min="1" max="100" value="{{ recipe_payload.portions or 4 }}" class="metadata-input">
      </label>
      <label>
        <span>Gesamtzeit (Minuten)</span>
        <input type="number" id="total-time-input" name="total_time" min="0" max="1440" value="{{ recipe_payload.total_time or 0 }}" class="metadata-input">
      </label>
    </fieldset>

    <div class="actions">
      <button type="submit" class="button" name="action" value="save" {% if not can_save %}disabled{% endif %}>Speichern</button>
      {% if recipe %}
      <a class="button muted" href="{{ url_for('recipe_detail', slug=recipe.slug) }}">Abbrechen</a>
      {% else %}
      <a class="button muted" href="{{ url_for('home') }}">Abbrechen</a>
      {% endif %}
    </div>
  </form>
</section>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.recipePromptEnhancerInitialized) return;
  window.recipePromptEnhancerInitialized = true;

  var promptField = document.querySelector('textarea[name="prompt_text"]');
  document.querySelectorAll('.prompt-chip').forEach(function (chip) {
    chip.addEventListener('click', function (event) {
      event.preventDefault();
      if (!promptField) return;
      var preset = chip.dataset.prompt || '';
      promptField.value = preset;
      promptField.focus();
    });
  });
  
  // Sync portions input with recipe_payload JSON
  var portionsInput = document.getElementById('portions-input');
  var totalTimeInput = document.getElementById('total-time-input');
  var payloadTextarea = document.querySelector('textarea[name="recipe_payload"]');
  
  if ((portionsInput || totalTimeInput) && payloadTextarea) {
    var updatePayload = function () {
      try {
        var payload = JSON.parse(payloadTextarea.value || '{}');
        if (portionsInput) payload.portions = parseInt(portionsInput.value) || 4;
        if (totalTimeInput) payload.total_time = parseInt(totalTimeInput.value) || 0;
        payloadTextarea.value = JSON.stringify(payload);
      } catch (e) {
        console.error('Failed to update payload:', e);
      }
    };
    
    if (portionsInput) portionsInput.addEventListener('change', updatePayload);
    if (totalTimeInput) totalTimeInput.addEventListener('change', updatePayload);
  }
});
</script>
{% endblock %}
{% endblock %}

